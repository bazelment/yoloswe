name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.10.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}-release
          repository-cache: true
          bazelrc: |
            common --enable_bzlmod

      - name: Extract version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building release ${VERSION}"

      - name: Build all cross-compilation targets
        run: |
          bazel build \
            //release:bramble_darwin_amd64 \
            //release:bramble_darwin_arm64 \
            //release:bramble_linux_amd64 \
            //release:bramble_linux_arm64 \
            //release:wt_darwin_amd64 \
            //release:wt_darwin_arm64 \
            //release:wt_linux_amd64 \
            //release:wt_linux_arm64

      - name: Create release archives
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          mkdir -p dist

          declare -A TARGETS=(
            ["bramble_darwin_amd64"]="bramble darwin amd64"
            ["bramble_darwin_arm64"]="bramble darwin arm64"
            ["bramble_linux_amd64"]="bramble linux amd64"
            ["bramble_linux_arm64"]="bramble linux arm64"
            ["wt_darwin_amd64"]="wt darwin amd64"
            ["wt_darwin_arm64"]="wt darwin arm64"
            ["wt_linux_amd64"]="wt linux amd64"
            ["wt_linux_arm64"]="wt linux arm64"
          )

          for target in "${!TARGETS[@]}"; do
            read -r tool os arch <<< "${TARGETS[$target]}"
            archive_name="${tool}-${VERSION}-${os}-${arch}.tar.gz"

            # Use bazel cquery to find the actual binary output path
            binary_path="$(bazel cquery --output=files "//release:${target}" 2>/dev/null)"

            # Create a temp dir and copy the binary with the tool name
            tmp_dir="$(mktemp -d)"
            cp "${binary_path}" "${tmp_dir}/${tool}"
            tar -czf "dist/${archive_name}" -C "${tmp_dir}" "${tool}"
            rm -rf "${tmp_dir}"

            echo "Created dist/${archive_name}"
          done

      - name: Generate checksums
        working-directory: dist
        run: |
          sha256sum *.tar.gz > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/checksums.txt

      - name: Update Homebrew tap
        if: ${{ !contains(steps.version.outputs.version, '-') }}
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          # Strip the 'v' prefix for the formula version
          FORMULA_VERSION="${VERSION#v}"

          # Read checksums into an associative array
          cd dist
          declare -A SHAS
          while read -r sha file; do
            SHAS["${file}"]="${sha}"
          done < checksums.txt
          cd ..

          # Clone the tap repo
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/bazelment/homebrew-tap.git" /tmp/homebrew-tap
          mkdir -p /tmp/homebrew-tap/Formula

          # Generate formulas from templates
          for tool in bramble wt; do
            sed -e "s/{{.Version}}/${FORMULA_VERSION}/g" \
                -e "s/{{.DarwinArm64SHA256}}/${SHAS["${tool}-${VERSION}-darwin-arm64.tar.gz"]}/g" \
                -e "s/{{.DarwinAmd64SHA256}}/${SHAS["${tool}-${VERSION}-darwin-amd64.tar.gz"]}/g" \
                -e "s/{{.LinuxArm64SHA256}}/${SHAS["${tool}-${VERSION}-linux-arm64.tar.gz"]}/g" \
                -e "s/{{.LinuxAmd64SHA256}}/${SHAS["${tool}-${VERSION}-linux-amd64.tar.gz"]}/g" \
                "packaging/homebrew/${tool}.rb.tmpl" > "/tmp/homebrew-tap/Formula/${tool}.rb"
          done

          # Commit and push
          cd /tmp/homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/
          git commit -m "Update formulas to ${VERSION}"
          git push
